# Домашнее задание к занятию "`«Резервное копирование баз данных»`" - `Бызгаев Александр`

---

### Задание 1. Резервное копирование

**Кейс**  

**Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования.**
**Необходимо описать, какие варианты резервного копирования подходят в случаях:**    
 **-1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.**    
 **-1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.**  
 **-1.3***.**Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.**    
**Приведите ответ в свободной форме.**

### Решение:

Для увеличения надежности работы баз данных и их резервного копирования финансовой компании следует организовать систему бэкапов и репликаций, которая позволит восстанавливать данные в соответствии с требованиями именно ее бизнеса. Как было сказано на вебинаре под каждый вид модели бизнеса свои порой схемы резервирования данных.    
Рассмотрим каждый из кейсов:

**1.1. Восстановление данных в полном объеме за предыдущий день.**  
Для такого сценария подойдет ежедневное полное резервное копирование (full backup). Все данные базы данных копируются в конце дня и хранятся на отдельных носителях или в удаленном хранилище.  
В случае сбоя, данные за весь предыдущий день можно восстановить, используя последний полный бэкап.

**1.2. Восстановление данных за час до предполагаемой поломки.**  
Для минимизации потери данных при сбое требуется более частое резервное копирование. Один из подходов — инкрементное резервное копирование (incremental backup).   
После ежедневного полного бэкапа, каждый час происходит копирование только тех данных, которые изменились с момента последнего бэкапа.   
Это уменьшает объем хранимых данных и время на восстановление, но при этом позволяет восстановить базу данных почти до момента сбоя.  

Альтернативой может быть непрерывное резервное копирование (continuous data protection), где каждая транзакция или изменение в базе данных тут же реплицируется на резервный сервер.   
Это обеспечивает возможность восстановления данных почти в реальном времени.

**1.3*** **.Моментальное переключение на работающую или починенную базу данных.**  
Для реализации моментального переключения на работающую базу данных в случае сбоя используются стратегии высокой доступности, такие как:

Репликация в реальном времени: синхронная или асинхронная репликация изменений на вторичный сервер базы данных обеспечивает наличие актуальной копии данных, готовой к переключению в случае сбоя основного сервера.

Кластеризация баз данных: группа серверов работает вместе так, что если один из них выходит из строя, другой автоматически берет на себя его функции. Это может быть реализовано через технологии, такие как Microsoft SQL Server Always On Availability Groups, Oracle Real Application Clusters (RAC) и другие.

Отказоустойчивые системы (fault-tolerant systems): системы, спроектированные так, чтобы при сбое одного компонента, другой компонент мгновенно заменял его без потери работы.

Системы распределённых баз данных: данные распределяются между несколькими узлами, которые могут находиться в разных географических локациях. Это обеспечивает географическое распределение рисков и возможность переключения на работающий узел при сбое другого.

Применение каждого из этих подходов зависит от требований бизнеса к доступности данных, времени на восстановление после сбоя (Recovery Time Objective, RTO) и допустимому объему потери данных (Recovery Point Objective, RPO), а также от бюджета, выделенного на обеспечение надежности баз данных.

Для ответа на 1.3* перелопатил инет и нашел похожие сценарии, которые мне показались похожими на правду. 

---

### Задание 2. PostgreSQL

**2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).**      
**2.1.*** **Возможно ли автоматизировать этот процесс? Если да, то как?**    
**Приведите ответ в свободной форме.**

### Решение:

**2.1. Резервирование данных и восстановление БД в PostgreSQL.**   

В PostgreSQL для резервного копирования данных используется утилита pg_dump, а для восстановления — pg_restore (для бинарных бэкапов) или psql (для SQL-форматированных бэкапов). Вот примеры команд:

Резервирование данных:

bash
pg_dump -U username -W -F c -f "/path_to_backup/backup_file.dump" dbname  
-U username — имя пользователя, под которым будет выполнена команда.  
-W — запрашивает пароль перед подключением к базе данных.  
-F c — указывает формат бэкапа (в данном случае, custom).  
-f — путь и имя файла для сохранения дампа.  
dbname — имя базы данных, которую нужно скопировать.   

Восстановление БД:  

bash  

pg_restore -U username -d dbname -W -F c -C "/path_to_backup/backup_file.dump".   
-U username — имя пользователя для подключения к базе данных.  
-d dbname — имя целевой базы данных, в которую будет восстановлен дамп.  
-W — запрашивает пароль пользователя.  
-F c — указывает формат бэкапа (custom).  
-C — создает базу данных перед восстановлением (если это необходимо).  
"/path_to_backup/backup_file.dump" — путь к файлу дампа.  

**2.1.*** **Автоматизация процесса резервного копирования и восстановления.**    

Автоматизировать процесс резервного копирования и восстановления данных в PostgreSQL можно несколькими способами, вот некоторые из них:  

Cron задания (Linux/Unix): Используя системный планировщик cron, можно настроить периодическое выполнение команды pg_dump для резервного копирования. Например, добавление следующей строки в crontab (crontab -e) позволит выполнять бэкап каждый день в полночь:
bash

0 0 * * * /usr/bin/pg_dump -U username -F c -f "/path_to_backup/backup_$(date +\%Y-\%m-\%d).dump" dbname.  
Скрипты оболочки: Можно написать скрипт на Bash или другом языке командной строки, который будет выполнять pg_dump и pg_restore, а затем настроить cron для его выполнения.  

Использование PostgreSQL Continuous Archiving:   
PostgreSQL позволяет настроить непрерывное архивирование (Continuous Archiving) и точки восстановления (Point-In-Time Recovery, PITR), что является частью более комплексной стратегии бэкапа и восстановления.    

Использование специализированного программного обеспечения:   
Существуют специализированные решения для бэкапа PostgreSQL, такие как Barman, pgBackRest и другие, которые предоставляют расширенные возможности управления резервными копиями и автоматизации.  

Интеграция с облачными сервисами:  
Если база данных размещена в облаке (например, на AWS, Azure, GCP), то можно использовать инструменты и сервисы облака для автоматизации резервного копирования и восстановления.  

При автоматизации важно также предусмотреть мониторинг успешности выполнения задачи резервного копирования, а также регулярно тестировать процесс восстановления, чтобы удостовериться в том, что данные могут быть восстановлены в случае необходимости.  


---

### Задание 3. MySQL

**3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL.**  
**3.1.*** **В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?**  
**Приведите ответ в свободной форме.**

### Решение:


**3.1. Инкрементное резервное копирование базы данных MySQL**  

Инкрементное резервное копирование в MySQL обычно выполняется с использованием утилиты mysqlbackup из MySQL Enterprise Backup (которая является платной) или с помощью бинлогов (binary logs) в стандартной версии MySQL.  
Однако, поскольку mysqlbackup является коммерческим продуктом, мы можем использовать функции бинарного логирования MySQL для инкрементного резервного копирования. Вот пример команды, которая создает инкрементный бэкап, используя binary logs:

```sh
mysqlbinlog --start-datetime="2023-03-01 00:00:00" \
            --stop-datetime="2023-03-02 00:00:00" \
            --to-last-log \
            --result-file="/path_to_backup/incremental_backup.sql" \
            binlog.000001 binlog.000002 ...
```

--start-datetime и --stop-datetime определяют временной промежуток, за который нужно извлечь изменения.  
--to-last-log указывает mysqlbinlog продолжить чтение бинарных логов до последнего доступного.  
--result-file задает путь и имя файла для сохранения SQL-команд, извлеченных из бинарных логов.  
binlog.000001 binlog.000002 ... - список бинарных логов для обработки.  
Перед использованием инкрементного резервного копирования на основе binary logs, необходимо будет включить их в конфигурации MySQL, установив log_bin.  


**3.1.*** **Преимущества использования реплики по сравнению с обычным резервным копированием.**  

Использование реплики в MySQL может дать ряд преимуществ по сравнению с традиционным резервным копированием:

**Нагрузка на производительность:**  
Репликация позволяет снизить нагрузку на основной сервер, так как операции чтения могут быть направлены на репликасервера, а также можно выполнять резервное копирование с реплики, не влияя на производительность основного сервера.

**Высокая доступность:**   
Реплики могут использоваться для быстрого переключения в случае отказа основного сервера, обеспечивая тем самым высокую доступность системы.

**Распределенные данные:**  
Репликация позволяет распределить данные по различным географическим локациям для обеспечения локальной близости данных к пользователям или для повышения устойчивости к сбоям.

**Масштабируемость:**   
Репликация может способствовать масштабированию системы путем добавления дополнительных реплик для обработки увеличенного объема операций чтения.

**Точка восстановления (Point-in-Time Recovery):**   
Репликация позволяет восстановить состояние базы данных на определенный момент времени, используя информацию из бинарных логов.

**Аналитические и отчетные запросы:**   
Реплики можно использовать для выполнения тяжелых аналитических и отчетных запросов без влияния на производительность основного рабочего сервера.

В то время как резервное копирование используется в основном для восстановления данных после сбоев, репликация вносит дополнительные возможности для улучшения доступности, масштабируемости и производительности системы.   

Однако, репликация и резервное копирование служат разным целям и могут дополнять друг друга в стратегии обеспечения надежности и доступности базы данных. Вот некоторые дополнительные различия и сценарии использования:

**Восстановление после катастрофы:**  
Резервное копирование является ключевым элементом стратегии восстановления после сбоев. В случае серьезного физического повреждения оборудования или потери данных в результате атаки или человеческой ошибки, резервные копии могут быть использованы для восстановления состояния базы данных до момента последнего бэкапа. Репликация, с другой стороны, может быть неэффективна в таких ситуациях, так как повреждение данных может распространиться и на реплики.

Обработка транзакций в реальном времени: Репликация позволяет иметь актуальные копии данных, которые можно использовать для непрерывной обработки транзакций, даже если основной сервер выйдет из строя. Это обеспечивает бесперебойную работу приложений, опирающихся на базу данных.

**Распределение нагрузки:**   
Репликация может использоваться для распределения нагрузки на чтение между несколькими серверами, что особенно полезно для обслуживания большого количества запросов на чтение. Резервное копирование не предоставляет такой возможности, так как его основная задача - архивация данных.

**Тестирование и разработка:**   
Реплики могут использоваться для создания стабильных сред для тестирования и разработки, где можно безопасно экспериментировать с данными, не влияя на рабочую базу данных.

**Регулярное обновление и мгновенный доступ:**  
Репликация синхронизирует данные между основным и реплицированными серверами почти в реальном времени, в то время как резервные копии создаются через определенные интервалы времени. Это означает, что реплики обеспечивают более актуальные данные для запросов и восстановления.

**Разграничение доступа:**  
Реплики могут быть настроены для предоставления доступа определенным пользователям или приложениям, что может помочь в обеспечении более строгой безопасности данных.

Важно отметить, что репликация не заменяет необходимости регулярного резервного копирования. Реплики могут быть подвержены тем же проблемам, что и основной сервер, включая повреждение данных, атаки и ошибки конфигурации. Поэтому сочетание репликации с регулярным резервным копированием обеспечивает более комплексную защиту и готовность к различным аварийным ситуациям.



















